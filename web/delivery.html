<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Confirmation de livraison – La Palette (démo)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    #cart-header button {
      border: none;
      background: #0070f3;
      color: #fff;
      padding: 0.35rem 0.75rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
    }
  </style>
</head>
<body style="font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 0; background: #f5f5f5;">
  <script defer src="header.js"></script>
  <script defer src="header.shared.js"></script>
  <main style="max-width:700px;margin:1.5rem auto;padding:0 1rem;">
    <div id="content" style="background:#fff;border-radius:6px;box-shadow:0 2px 4px rgba(0,0,0,0.06);padding:1rem;">
      <h1 style="margin-top:0;">Confirmation de livraison</h1>
      <p id="status">Vérification de la commande...</p>
    </div>
  </main>
  <script>
    (function () {
      var loginBtn = document.getElementById('login-header-btn');
      if (loginBtn) {
        loginBtn.addEventListener('click', function () {
          window.location.href = 'login.html';
        });
      }

      var roleSelect = document.getElementById('role-header-select');
      if (roleSelect) {
        var initialRole = 'DELIVERY';
        try {
          var rawUser = window.localStorage.getItem('lp_auth_user');
          if (rawUser) {
            var u = JSON.parse(rawUser) || {};
            if (u.role) {
              var r = String(u.role).toUpperCase();
              if (r === 'SHOP') initialRole = 'SHOP';
              else if (r === 'ADMIN') initialRole = 'ADMIN';
              else if (r === 'CLIENT') initialRole = 'CLIENT';
            }
          }
        } catch (e) {}
        roleSelect.value = initialRole;

        roleSelect.addEventListener('change', function () {
          var value = roleSelect.value;
          if (!value) return;
          if (value === 'CLIENT') {
            window.location.href = 'index.html';
          } else if (value === 'SHOP' || value === 'ADMIN') {
            window.location.href = 'orders.html';
          } else if (value === 'DELIVERY') {
            window.location.href = 'delivery-list.html';
          }
        });
      }

      var presentationBtn = document.getElementById('presentation-header-btn');
      if (presentationBtn) {
        presentationBtn.addEventListener('click', function () {
          window.location.href = 'presentation.html';
        });
      }

      var myOrdersBtn = document.getElementById('myorders-header-btn');
      if (myOrdersBtn) {
        myOrdersBtn.addEventListener('click', function () {
          window.location.href = 'index.html';
        });
      }

      var profileBtn = document.getElementById('profile-header-btn');
      if (profileBtn) {
        profileBtn.addEventListener('click', function () {
          window.location.href = 'profile.html';
        });
      }
    })();
  </script>

  <script>
    (function() {
      function getCodeFromUrl() {
        var params = new URLSearchParams(window.location.search || '');
        var code = params.get('code');
        if (code) return code;
        // fallback from hash like #code=...
        if (window.location.hash && window.location.hash.indexOf('code=') !== -1) {
          var hashParams = new URLSearchParams(window.location.hash.slice(1));
          return hashParams.get('code');
        }
        return null;
      }

      var statusEl = document.getElementById('status');
      var code = getCodeFromUrl();
      if (!code) {
        statusEl.textContent = "Code de commande manquant dans l'URL (démo).";
        statusEl.style.color = '#b71c1c';
        return;
      }

      statusEl.textContent = 'Validation de la commande ' + code + '...';

      fetch('http://localhost:3002/api/orders/deliver/' + encodeURIComponent(code), {
        method: 'POST'
      })
        .then(function(res) {
          if (!res.ok) throw new Error('HTTP ' + res.status);
          return res.json();
        })
        .then(function(data) {
          statusEl.innerHTML = '';
          var p = document.createElement('p');
          p.textContent = 'La livraison de la commande ' + (data.publicOrderCode || code) + ' a été confirmée (démo).';
          p.style.color = '#1b5e20';
          var info = document.createElement('p');
          info.textContent = 'Merci. Ce flux illustre la confirmation par scan de QR code.';
          document.getElementById('content').appendChild(p);
          document.getElementById('content').appendChild(info);
        })
        .catch(function(err) {
          console.error('Failed to confirm delivery (demo)', err);
          statusEl.textContent = "Erreur lors de la confirmation de livraison (démo).";
          statusEl.style.color = '#b71c1c';
        });
    })();
  </script>
</body>
</html>
