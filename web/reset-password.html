<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Réinitialisation du mot de passe – La Palette (démo)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f5f5f5;
    }
    header {
      background: #e0001a;
      color: #fff;
      padding: 0.75rem 1.25rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      letter-spacing: 0.03em;
    }
    .container {
      max-width: 480px;
      margin: 2.5rem auto;
      padding: 0 1rem;
    }
    .card {
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
      padding: 1.25rem 1.5rem 1.5rem;
      font-size: 0.9rem;
    }
    h1 {
      margin-top: 0;
      font-size: 1.2rem;
      margin-bottom: 0.5rem;
    }
    p {
      margin-top: 0.25rem;
      margin-bottom: 0.5rem;
    }
    ul {
      margin-top: 0.35rem;
      margin-bottom: 0.5rem;
      padding-left: 1.2rem;
    }
    code {
      font-size: 0.8rem;
      background: #f0f0f0;
      padding: 0.1rem 0.25rem;
      border-radius: 3px;
    }
    a.button-link {
      display: inline-block;
      margin-top: 0.75rem;
      padding: 0.35rem 0.7rem;
      background: #0070f3;
      color: #fff;
      text-decoration: none;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    label {
      display: block;
      font-size: 0.85rem;
      margin-top: 0.5rem;
      margin-bottom: 0.2rem;
    }
    input[type="email"],
    input[type="password"] {
      width: 100%;
      padding: 0.4rem 0.5rem;
      font-size: 0.9rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      border: none;
      background: #0070f3;
      color: #fff;
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      margin-top: 0.75rem;
    }
    .status {
      margin-top: 0.5rem;
      font-size: 0.85rem;
    }
    .status.error {
      color: #b71c1c;
    }
    .status.ok {
      color: #1b5e20;
    }
    #cart-header button {
      border: none;
      background: #0070f3;
      color: #fff;
      padding: 0.35rem 0.75rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
    }
  </style>
</head>
<body>
  <script defer src="header.js"></script>
  <div class="container">
    <div class="card">
      <h1>Mot de passe oublié (démo)</h1>
      <p>Dans cette démonstration, vous pouvez définir un nouveau mot de passe pour un compte existant.</p>
      <p><strong>Attention :</strong> la modification est uniquement en mémoire et sera perdue au prochain redémarrage du serveur.</p>

      <label for="email">Adresse e-mail du compte</label>
      <input id="email" type="email" placeholder="ex: shop3@lapalette.demo" autocomplete="username" />

      <label for="old-password">Ancien mot de passe</label>
      <input id="old-password" type="password" autocomplete="current-password" />

      <label for="new-password">Nouveau mot de passe</label>
      <input id="new-password" type="password" autocomplete="new-password" />

      <label for="new-password-confirm">Nouveau mot de passe (confirmation)</label>
      <input id="new-password-confirm" type="password" autocomplete="new-password" />

      <button id="reset-btn" type="button">Réinitialiser le mot de passe (démo)</button>
      <div id="status" class="status"></div>

      <p style="margin-top:0.75rem; font-size:0.85rem; color:#555;">
        Comptes démo existants : <code>client@lapalette.demo</code>, <code>admin@lapalette.demo</code>,
        et <code>shop1@lapalette.demo</code> à <code>shop18@lapalette.demo</code>.
      </p>

      <a class="button-link" href="login.html">Retour à la connexion</a>
    </div>
  </div>
  <script>
    (function () {
      var roleSelect = document.getElementById('role-header-select');
      if (roleSelect) {
        try {
          var rawUser = window.localStorage.getItem('lp_auth_user');
          if (rawUser) {
            var u = JSON.parse(rawUser) || {};
            if (u.role) {
              var r = String(u.role).toUpperCase();
              if (r === 'CLIENT') roleSelect.value = 'CLIENT';
              else if (r === 'SHOP') roleSelect.value = 'SHOP';
              else if (r === 'ADMIN') roleSelect.value = 'ADMIN';
              else if (r === 'DELIVERY') roleSelect.value = 'DELIVERY';
            }
          }
        } catch (e) {}

        roleSelect.addEventListener('change', function () {
          var value = roleSelect.value;
          if (!value) return;
          if (value === 'CLIENT') {
            window.location.href = 'index.html';
          } else if (value === 'SHOP' || value === 'ADMIN') {
            window.location.href = 'orders.html';
          } else if (value === 'DELIVERY') {
            window.location.href = 'delivery-list.html';
          }
        });
      }

      var loginBtn = document.getElementById('login-header-btn');
      if (loginBtn) {
        loginBtn.addEventListener('click', function () {
          window.location.href = 'login.html';
        });
      }

      var presentationBtn = document.getElementById('presentation-header-btn');
      if (presentationBtn) {
        presentationBtn.addEventListener('click', function () {
          window.location.href = 'presentation.html';
        });
      }

      var myOrdersBtn = document.getElementById('myorders-header-btn');
      if (myOrdersBtn) {
        myOrdersBtn.addEventListener('click', function () {
          window.location.href = 'index.html';
        });
      }

      var profileBtn = document.getElementById('profile-header-btn');
      if (profileBtn) {
        profileBtn.addEventListener('click', function () {
          window.location.href = 'profile.html';
        });
      }
    })();
  </script>

  <script>
    (function () {
      var emailInput = document.getElementById('email');
      var oldPasswordInput = document.getElementById('old-password');
      var newPasswordInput = document.getElementById('new-password');
      var newPasswordConfirmInput = document.getElementById('new-password-confirm');
      var resetBtn = document.getElementById('reset-btn');
      var statusEl = document.getElementById('status');

      function setStatus(msg, type) {
        if (!statusEl) return;
        statusEl.textContent = msg || '';
        statusEl.className = 'status' + (type ? ' ' + type : '');
      }

      if (resetBtn) {
        resetBtn.addEventListener('click', function () {
          var email = (emailInput.value || '').trim();
          var oldPwd = (oldPasswordInput.value || '').trim();
          var pwd = (newPasswordInput.value || '').trim();
          var pwd2 = (newPasswordConfirmInput.value || '').trim();
          if (!email || !oldPwd || !pwd || !pwd2) {
            setStatus('Merci de renseigner tous les champs (e-mail, ancien mot de passe, nouveau mot de passe et confirmation).', 'error');
            return;
          }
          if (pwd.length < 4) {
            setStatus('Le nouveau mot de passe doit contenir au moins 4 caractères (démo).', 'error');
            return;
          }
          if (pwd !== pwd2) {
            setStatus('Les deux saisies du nouveau mot de passe ne correspondent pas.', 'error');
            return;
          }
          setStatus('Envoi de la demande de réinitialisation (démo)...', '');
          resetBtn.disabled = true;

          fetch('http://localhost:3002/auth/reset-demo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: email, oldPassword: oldPwd, newPassword: pwd })
          })
            .then(function (resp) { return resp.json(); })
            .then(function (data) {
              resetBtn.disabled = false;
              if (!data || !data.success) {
                setStatus((data && data.message) || 'Échec de la réinitialisation (démo).', 'error');
                return;
              }
              setStatus(data.message || 'Mot de passe mis à jour (démo).', 'ok');
            })
            .catch(function (err) {
              console.error('Erreur lors de la réinitialisation de mot de passe (démo)', err);
              resetBtn.disabled = false;
              setStatus('Erreur lors de la réinitialisation (démo).', 'error');
            });
        });
      }
    })();
  </script>
</body>
</html>
