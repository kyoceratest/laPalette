<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Commandes à livrer – La Palette (démo)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f5f5f5;
    }
    header {
      background: #e0001a;
      color: #fff;
      padding: 0.75rem 1.25rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      letter-spacing: 0.03em;
    }
    #cart-header button {
      border: none;
      background: #0070f3;
      color: #fff;
      padding: 0.35rem 0.75rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .container {
      max-width: 900px;
      margin: 0.75rem auto 2rem;
      padding: 0 1rem;
    }
    h1 {
      margin-top: 0.5rem;
      margin-bottom: 0.75rem;
      font-size: 1.3rem;
    }
    .small {
      font-size: 0.8rem;
      color: #666;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 6px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.06);
      font-size: 0.9rem;
      margin-top: 0.75rem;
    }
    th, td {
      padding: 0.45rem 0.7rem;
      border-bottom: 1px solid #eee;
      text-align: left;
      white-space: nowrap;
    }
    th:last-child,
    td:last-child {
      text-align: right;
    }
    tr:last-child td {
      border-bottom: none;
    }
    .code {
      font-family: 'SFMono-Regular', Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
      font-size: 0.85rem;
    }
    .tag-status {
      display: inline-block;
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #e3f2fd;
      color: #0d47a1;
    }
    .btn-confirm {
      border: none;
      background: #0070f3;
      color: #fff;
      padding: 0.3rem 0.6rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
    }
    .empty {
      margin-top: 0.75rem;
      padding: 0.75rem 0.9rem;
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.04);
      font-size: 0.9rem;
    }

    /* Detail card below the table (similar to client view) */
    .delivery-detail-card {
      margin-top: 0.75rem;
      padding: 0.7rem 1rem;
      border-radius: 6px;
      background: #e9e9e9;
      font-size: 0.9rem;
    }

    .delivery-detail-flex {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      align-items: flex-start;
    }

    .delivery-detail-col {
      flex: 1 1 230px;
    }

    @media (max-width: 768px) {
      /* Header is controlled by shared header (header.js) */
      /* Stack detail columns vertically on small screens */
      .delivery-detail-flex {
        flex-direction: column;
      }

      .delivery-detail-col {
        flex: 1 1 100%;
      }
    }
  </style>
</head>
<body>
  <script src="config.js?v=20260114"></script>
  <script>console.log('API_BASE:', window.API_BASE);</script>
  <script defer src="header.js"></script>
  <div class="container">
    <h1>Commandes prêtes à livrer (démo)</h1>
    <p class="small">Vue livreur démo. Seules les commandes marquées <code>READY_FOR_DELIVERY</code> sont affichées.</p>
    <div id="status" class="small" style="margin-top:0.5rem;">Chargement des commandes...</div>
    <div id="list"></div>
    <div id="delivery-detail"></div>
  </div>

  <script>
    (function () {
      // Header interactions are handled by shared header (header.js)
    })();
  </script>

  <script>
    (function () {
      // Auth guard: only DELIVERY role can see this page (demo)
      var rawUser = null;
      var user = null;
      try {
        rawUser = window.localStorage.getItem('lp_auth_user');
        user = rawUser ? JSON.parse(rawUser) : null;
      } catch (e) {
        user = null;
      }
      var role = user && user.role ? String(user.role).toUpperCase() : '';
      // Allow both DELIVERY and ADMIN roles to access this page (admin has all rights in demo)
      var allowed = (role === 'DELIVERY' || role === 'ADMIN');
      if (!allowed) {
        document.body.innerHTML = '<header style="background:#e0001a;color:#fff;padding:0.75rem 1.25rem;font-weight:600;letter-spacing:0.03em;">La Palette – Livraison (démo)</header>' +
          '<main style="max-width:900px;margin:1.25rem auto 2rem;padding:0 1rem;">' +
          '<div style="background:#fff;border-radius:6px;box-shadow:0 2px 4px rgba(0,0,0,0.06);padding:1rem;">' +
          '<h1 style="margin-top:0;font-size:1.3rem;">Accès restreint (démo)</h1>' +
          '<p>Cette page est réservée au rôle "Livraison" (démo).</p>' +
          '<p>Merci de vous connecter via la page <a href="login.html">Connexion (démo)</a>.</p>' +
          '</div></main>';
        return;
      }

      var statusEl = document.getElementById('status');
      var listEl = document.getElementById('list');
      var detailRoot = document.getElementById('delivery-detail');

      function setStatus(msg, isError) {
        if (!statusEl) return;
        statusEl.textContent = msg || '';
        statusEl.style.color = isError ? '#b71c1c' : '#666';
      }

      // Simple in-memory cache for order details so we don't refetch every time
      var detailsCache = {};
      var expandedOrderId = null;

      function clearDetail() {
        expandedOrderId = null;
        if (detailRoot) {
          detailRoot.innerHTML = '';
        }
      }

      function render(orders) {
        if (!orders || !orders.length) {
          listEl.innerHTML = '<div class="empty">Aucune commande "READY_FOR_DELIVERY" à livrer pour le moment (démo).</div>';
          clearDetail();
          return;
        }
        var html = '';
        html += '<table>';
        html += '<thead><tr>';
        html += '<th>Code</th><th>Client</th><th>Adresse</th><th>Total (€)</th><th>Statut</th><th style="text-align:right;">Actions</th>';
        html += '</tr></thead><tbody>';
        orders.forEach(function (o) {
          var codeRaw = o.publicOrderCode || o.orderId;
          var code = encodeURIComponent(codeRaw || '');
          var url = code ? ('delivery.html?code=' + code) : '#';

          html += '<tr class="order-row" data-order-id="' + (o.orderId || '') + '">';
          html += '<td class="code">' + (codeRaw || '') + '</td>';
          html += '<td>' + (o.customerName || '') + '</td>';
          html += '<td>' + (o.address || '') + '</td>';
          html += '<td>' + Number(o.totalAmount || 0).toFixed(2) + '</td>';
          html += '<td><span class="tag-status">READY_FOR_DELIVERY</span></td>';
          html += '<td style="text-align:right;">';
          html += '<button type="button" class="btn-confirm" data-role="detail" data-order-id="' + (o.orderId || '') + '">Détails / préparation</button> ';
          if (code) {
            // In this démo, this button simule le scan du QR côté client en ouvrant la même URL de confirmation.
            html += '<button type="button" class="btn-confirm" data-role="scan" data-url="' + url + '">Scanner le QR du client (démo)</button>';
          } else {
            html += '<span class="small">Code manquant</span>';
          }
          html += '</td>';
          html += '</tr>';
        });
        html += '</tbody></table>';
        listEl.innerHTML = html;

        // Wire detail buttons
        var buttons = listEl.querySelectorAll('button[data-role="detail"]');
        for (var i = 0; i < buttons.length; i++) {
          (function (btn) {
            btn.addEventListener('click', function () {
              var orderId = btn.getAttribute('data-order-id');
              if (!orderId) return;

              // Toggle behavior: close if already open
              if (expandedOrderId && expandedOrderId === orderId) {
                clearDetail();
                return;
              }

              expandedOrderId = orderId;
              if (!detailRoot) return;

              // Use cache when available
              if (detailsCache[orderId]) {
                detailRoot.innerHTML = detailsCache[orderId];
                return;
              }

              detailRoot.innerHTML = '<div class="delivery-detail-card">Chargement du détail de la commande…</div>';
              (function(){
                var base = (window.API_BASE || 'https://lapalette.onrender.com').replace(/\/$/, '');
                if (!window.API_BASE) { try { console.warn('API_BASE missing; using fallback', base); } catch(e){} }
                return fetch(base + '/api/orders/' + orderId + '?t=' + Date.now())
              })()
                .then(function (res) {
                  if (!res.ok) throw new Error('HTTP ' + res.status);
                  return res.json();
                })
                .then(function (data) {
                  // data structure is the same as used on client side (index.html MyOrdersView)
                  var order = data && data.order ? data.order : {};
                  var items = data && data.items ? data.items : [];

                  var html = '';
                  html += '<div class="delivery-detail-card">';
                  html += '<div class="delivery-detail-flex">';

                  // Col 1: main info
                  html += '<div class="delivery-detail-col">';
                  html += '<p><strong>Commande :</strong> ' + (order.publicOrderCode || order.orderId || orderId) + '</p>';
                  if (order.customerName || order.email) {
                    html += '<p><strong>Client :</strong> ' + (order.customerName || '') + (order.email ? ' – ' + order.email : '') + '</p>';
                  }
                  if (order.shopName) {
                    html += '<p><strong>Magasin :</strong> ' + order.shopName + '</p>';
                  }
                  if (order.address) {
                    html += '<p><strong>Adresse :</strong> ' + order.address + '</p>';
                  }
                  if (order.deliveryMode) {
                    html += '<p><strong>Mode de livraison :</strong> ' + order.deliveryMode + '</p>';
                  }
                  if (order.deliveryDate || order.deliveryTimeSlot) {
                    html += '<p><strong>Créneau de livraison :</strong> ' + (order.deliveryDate || '') + (order.deliveryTimeSlot ? ' – ' + order.deliveryTimeSlot : '') + '</p>';
                  }
                  html += '</div>';

                  // Col 2: items + total
                  html += '<div class="delivery-detail-col">';
                  html += '<p><strong>Articles :</strong></p>';
                  if (items && items.length) {
                    html += '<ul style="margin:0;padding-left:1.1rem;font-size:0.85rem;">';
                    items.forEach(function (it) {
                      var label = it.productName || ('Produit #' + it.productId);
                      html += '<li>' + label + ' – Qté ' + (it.quantity || 0) + ' × €' + Number(it.unitPrice || 0).toFixed(2) + '</li>';
                    });
                    html += '</ul>';
                  } else {
                    html += '<p class="small">Aucun article détaillé trouvé pour cette commande (démo).</p>';
                  }
                  html += '<p style="margin-top:0.6rem;"><strong>Total :</strong> €' + Number(order.totalAmount || 0).toFixed(2) + '</p>';
                  html += '</div>'; // end right col

                  html += '</div>'; // end flex
                  html += '</div>'; // end card

                  detailsCache[orderId] = html;
                  detailRoot.innerHTML = html;
                })
                .catch(function (err) {
                  console.error('Failed to load order detail for delivery list (demo)', err);
                  container.textContent = 'Erreur lors du chargement du détail de la commande (démo).';
                });
            });
          })(buttons[i]);
        }

        // Wire "scan" buttons (simulate scanning by opening the confirmation URL)
        var scanButtons = listEl.querySelectorAll('button[data-role="scan"]');
        for (var j = 0; j < scanButtons.length; j++) {
          (function (btnScan) {
            btnScan.addEventListener('click', function () {
              var url = btnScan.getAttribute('data-url');
              if (!url) return;
              // In real life the client scans the QR; in this démo we just open the confirmation page.
              window.open(url, '_blank');
            });
          })(scanButtons[j]);
        }
      }

      function load() {
        setStatus('Chargement des commandes prêtes à livrer...', false);
        (function(){
          var base = (window.API_BASE || 'https://lapalette.onrender.com').replace(/\/$/, '');
          if (!window.API_BASE) { try { console.warn('API_BASE missing; using fallback', base); } catch(e){} }
          return fetch(base + '/api/orders?t=' + Date.now())
        })()
          .then(function (res) {
            if (!res.ok) throw new Error('HTTP ' + res.status);
            return res.json();
          })
          .then(function (rows) {
            rows = Array.isArray(rows) ? rows : [];
            // Keep only READY_FOR_DELIVERY orders, and optionally same shop as the delivery user
            var shopId = user && typeof user.shopId !== 'undefined' && user.shopId !== null
              ? Number(user.shopId)
              : null;
            var filtered = rows.filter(function (o) {
              var s = String(o.status || '').toUpperCase();
              if (s !== 'READY_FOR_DELIVERY') return false;
              if (shopId && typeof o.shopId !== 'undefined' && o.shopId !== null) {
                return Number(o.shopId) === shopId;
              }
              return true;
            });
            setStatus(filtered.length ? '' : 'Aucune commande prête à livrer pour le moment (démo).', false);
            render(filtered);
          })
          .catch(function (err) {
            console.error('Failed to load ready-for-delivery orders (delivery list demo)', err);
            setStatus('Erreur lors du chargement des commandes prêtes à livrer (démo).', true);
          });
      }

      load();
    })();
  </script>
</body>
</html>
