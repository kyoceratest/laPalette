<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>La Palette Shop (Dev)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Montserrat', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f5f5f5;
    }
    header {
      background: #e0001a;
      color: #fff;
      padding: 0.75rem 1.25rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      letter-spacing: 0.03em;
    }
    .container {
      max-width: 1100px;
      margin: 0.75rem auto;
      padding: 0 1rem;
      display: grid;
      grid-template-columns: 240px 1fr;
      gap: 1rem;
      align-items: flex-start;
    }
    .products {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem;
    }
    .product-card {
      background: #fff;
      border-radius: 6px;
      padding: 0.75rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease;
    }
    .product-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.12);
    }
    .product-image {
      width: 100%;
      border-radius: 4px;
      object-fit: cover;
      max-height: 180px;
      margin-bottom: 0.5rem;
      background: #eee;
    }
    .product-card h3 {
      margin: 0 0 0.25rem;
      font-size: 1rem;
    }
    .product-card p {
      margin: 0 0 0.5rem;
      font-size: 0.9rem;
    }
    .price {
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    button {
      border: none;
      background: #0070f3;
      color: #fff;
      padding: 0.4rem 0.6rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .cart-summary {
      background: #fff;
      border-radius: 6px;
      padding: 0.75rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.06);
      margin-bottom: 1rem;
    }
    .sidebar {
      background: #fff;
      border-radius: 6px;
      padding: 0.75rem 0.75rem 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.06);
      font-size: 0.9rem;
    }
    .sidebar h3 {
      margin-top: 0;
      font-size: 0.95rem;
      border-bottom: 1px solid #ddd;
      padding-bottom: 0.25rem;
      margin-bottom: 0.5rem;
    }
    .sidebar ul {
      list-style: none;
      margin: 0 0 0.75rem;
      padding-left: 0.75rem;
    }
    .sidebar li {
      margin-bottom: 0.2rem;
      cursor: default;
    }
    .sidebar .section-title {
      font-weight: 600;
      margin-top: 0.5rem;
    }
    .category-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .category-chip {
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      border: 1px solid #ccc;
      background: #fff;
      font-size: 0.85rem;
      cursor: pointer;
    }
    .category-chip.active {
      background: #0070f3;
      color: #fff;
      border-color: #0070f3;
    }
    .cart-summary ul {
      list-style: none;
      padding-left: 0;
      margin: 0.5rem 0 0;
      font-size: 0.9rem;
    }
    .cart-summary li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      padding: 0.25rem 0;
    }
    .cart-summary-item-main {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      flex: 1 1 auto;
      min-width: 0;
    }
    .cart-qty-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      border-radius: 999px;
      background: #0070f3;
      color: #fff;
      font-size: 0.75rem;
      font-weight: 600;
      flex-shrink: 0;
    }
    .cart-summary-item-text {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .cart-remove-icon-btn {
      background: #cc0000;
      padding: 0.15rem 0.4rem;
      border-radius: 999px;
      font-size: 0.75rem;
      line-height: 1;
      flex-shrink: 0;
    }
    .cart-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      border-radius: 999px;
      background: #e0001a;
      color: #fff;
      font-size: 0.75rem;
      flex-shrink: 0;
    }
    .cart-qty-step {
      background: #eee;
      color: #333;
      padding: 0.1rem 0.4rem;
      border-radius: 999px;
      font-size: 0.75rem;
      line-height: 1;
      flex-shrink: 0;
    }
    /* Badge base styles (status/payment) */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }
    .badge-icon {
      display: inline-block;
      font-size: 0.95em;
      margin-right: 0.25rem;
    }
    .badge-text { display: inline; }
    .detail-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .detail-panel {
      background: #fff;
      max-width: 600px;
      width: 90%;
      border-radius: 8px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.25);
      padding: 1rem;
      max-height: 90vh;
      overflow-y: auto;
    }
    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .detail-image {
      width: 100%;
      border-radius: 6px;
      object-fit: cover;
      max-height: 260px;
      background: #eee;
      margin-bottom: 0.75rem;
    }
    /* Mobile-only filter dropdown (hidden by default) */
    .mobile-filter {
      display: none;
      width: 100%;
      padding: 0.35rem 0.5rem;
      font-size: 0.9rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      margin: 0.25rem 0 0.75rem;
      background: #fff;
    }
    /* Responsive layout for mobile */
    @media (max-width: 768px) {
      body {
        font-size: 14px;
      }

      header {
        flex-direction: row;
        align-items: center;
        gap: 0.5rem;
      }

      #cart-header { display: none; }

      .container {
        display: block;
        max-width: 100%;
        margin: 0.5rem auto;
        padding: 0 0.5rem;
      }

      .sidebar {
        margin-bottom: 0.75rem;
      }

      /* Hide only top-level static lists on mobile; keep cart items visible */
      .sidebar > ul { display: none; }
      .sidebar .section-title { display: none; }

      .products {
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      }

      .cart-summary {
        margin-bottom: 0.75rem;
      }

      /* Show mobile dropdown; hide chip bar for compact UI */
      .mobile-filter { display: block; }
      .category-bar { display: none; }

      /* Badges: show icon only on mobile */
      .badge-text { display: none; }
      .badge-icon { margin-right: 0; }

      /* Mobile hamburger handled by shared header */
    }
  </style>
</head>
<body>
  <div id="lp-header-root"></div>
  <div class="container">
    <aside class="sidebar">
      <h3>Peinture Int√©rieure</h3>
      <ul>
        <li>Mat</li>
        <li>Impression s/s couche</li>
        <li>Velours</li>
        <li>Satin</li>
        <li>Brillant</li>
      </ul>
      <div class="section-title">Par marque (Faites votre choix)</div>
      <ul>
        <li>Toutes les marques</li>
        <li>Complice</li>
        <li>Dularex</li>
        <li>Tollens</li>
      </ul>
      <div id="cart-sidebar-root"></div>
    </aside>
    <main id="root">Loading...</main>
  </div>

  <script defer src="config.js"></script>
  <script defer src="header.js"></script>
  <!-- React via CDN (dev only) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script>
    const { useState, useEffect, useRef } = React;

    // Normalize image URLs so that DB values like
    // - "filename.jpg" or "C1 Chantier.jpg"
    // - "image/filename.jpg"
    // map to the deployed path under "image/..." (relative) in the web folder.
    function normalizeImageUrl(u) {
      if (!u) return '';
      try {
        var s = String(u).trim();
        if (!s) return '';
        if (/^https?:\/\//i.test(s)) return s; // external URL
        // Ensure it starts with image/ (relative), not absolute /image/ to work under /laPalette/web/
        s = s.replace(/^\/+/, ''); // remove any leading slashes
        if (!/^image\//i.test(s)) {
          s = 'image/' + s;
        }
        return s;
      } catch (e) { return ''; }
    }

    // Separate React root for the cart inside the left sidebar
    var cartSidebarRoot = (function () {
      var el = document.getElementById('cart-sidebar-root');
      return el ? ReactDOM.createRoot(el) : null;
    })();

    function App() {
      const [products, setProducts] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState('');
      const [cart, setCart] = useState([]); // [{product, qty}]
      const [selectedProduct, setSelectedProduct] = useState(null);
      const [selectedCategory, setSelectedCategory] = useState('All');
      const [view, setView] = useState('catalog'); // 'catalog' | 'checkout' | 'myOrders'
      const [selectedBrand, setSelectedBrand] = useState('All');

      useEffect(() => {
        async function loadProducts() {
          try {
            const base = (window.API_BASE || '').replace(/\/$/, '');
            const res = await fetch(base + '/api/products');
            if (!res.ok) {
              throw new Error('HTTP ' + res.status);
            }
            const data = await res.json();
            setProducts(data);
          } catch (err) {
            console.error('Failed to load products', err);
            setError('Failed to load products');
          } finally {
            setLoading(false);
          }
        }
        loadProducts();

        // Listen for header "My orders" button
        function handleMyOrdersRequested() {
          setView('myOrders');
        }
        if (window.addEventListener) {
          window.addEventListener('lp-myorders-requested', handleMyOrdersRequested);
        }
        return function cleanup() {
          if (window.removeEventListener) {
            window.removeEventListener('lp-myorders-requested', handleMyOrdersRequested);
          }
        };
      }, []);

      // Shared header manages mobile hamburger; no page-local wiring needed here

      function addToCart(product, quantity) {
        const delta = Number(quantity);
        const addQty = !delta || delta <= 0 ? 1 : Math.floor(delta);
        setCart(prev => {
          const existing = prev.find(item => item.product.id === product.id);
          if (existing) {
            return prev.map(item =>
              item.product.id === product.id
                ? { ...item, qty: item.qty + addQty }
                : item
            );
          }
          return [...prev, { product, qty: addQty }];
        });
      }

      function removeFromCart(productId) {
        setCart(prev => prev.filter(item => item.product.id !== productId));
      }

      function changeCartQty(productId, delta) {
        const d = Number(delta) || 0;
        if (!d) return;
        setCart(prev => {
          const next = prev.map(item => {
            if (item.product.id !== productId) return item;
            const newQty = item.qty + d;
            return { ...item, qty: newQty };
          }).filter(item => item.qty > 0);
          return next;
        });
      }

      const total = cart.reduce((sum, item) => sum + Number(item.product.price) * item.qty, 0);

      const categories = React.useMemo(() => {
        const set = new Set();
        products.forEach(function (p) {
          var c = p.category || p.categoryName || p.type || p.family || p.group || '';
          if (typeof c === 'string') {
            c = c.trim();
          }
          if (c) set.add(c);
        });
        return ['All', ...Array.from(set)];
      }, [products]);

      const brands = React.useMemo(() => {
        const set = new Set();
        products.forEach(p => {
          const b = p.brand || p.brandName || p.manufacturer || '';
          if (b) set.add(b);
        });
        return ['All', ...Array.from(set)];
      }, [products]);

      const visibleProducts = products.filter(p => {
        // category filter
        if (selectedCategory !== 'All' && p.category !== selectedCategory) {
          return false;
        }
        // brand filter (supports brand | brandName | manufacturer)
        if (selectedBrand !== 'All') {
          const b = p.brand || p.brandName || p.manufacturer || '';
          if (b !== selectedBrand) return false;
        }
        return true;
      });

      // Render the cart summary into the sidebar container when cart/total change
      useEffect(() => {
        if (!cartSidebarRoot) return;
        cartSidebarRoot.render(
          React.createElement(CartSummary, {
            cart,
            total,
            onRemove: removeFromCart,
            onCheckout: () => setView('checkout'),
            onShowMyOrders: () => setView('myOrders'),
            onChangeQty: changeCartQty
          })
        );
      }, [cart, total]);

      if (loading) {
        return React.createElement('div', null, 'Loading products...');
      }
      if (error) {
        return React.createElement('div', { style: { color: 'red' } }, error);
      }

      if (view === 'checkout') {
        return React.createElement(CheckoutView, {
          cart,
          total,
          onBack: () => setView('catalog'),
          onClearCart: () => setCart([])
        });
      }

      if (view === 'myOrders') {
        return React.createElement(MyOrdersView, {
          onBackToShop: () => setView('catalog')
        });
      }

      return React.createElement(
        React.Fragment,
        null,
        // Mobile-only dropdowns for category and brand
        React.createElement(
          'select',
          {
            className: 'mobile-filter',
            value: selectedCategory,
            onChange: function (e) { setSelectedCategory(e.target.value); },
            'aria-label': 'Filtrer par cat√©gorie'
          },
          categories.map(function (c) {
            var label = c === 'All' ? 'Category' : c;
            return React.createElement('option', { key: c, value: c }, label);
          })
        ),
        React.createElement(
          'select',
          {
            className: 'mobile-filter',
            value: selectedBrand,
            onChange: function (e) { setSelectedBrand(e.target.value); },
            'aria-label': 'Filtrer par marque'
          },
          brands.map(function (b) {
            var label = b === 'All' ? 'Brand' : b;
            return React.createElement('option', { key: b, value: b }, label);
          })
        ),
        React.createElement(CategoryBar, {
          categories,
          selectedCategory,
          onSelectCategory: setSelectedCategory
        }),
        selectedProduct && React.createElement(ProductDetail, {
          product: selectedProduct,
          onClose: () => setSelectedProduct(null),
          onAddToCart: addToCart
        }),
        React.createElement(ProductList, {
          products: visibleProducts,
          onAddToCart: addToCart,
          onSelect: setSelectedProduct
        })
      );
    }

    function MyOrdersView({ onBackToShop }) {
      const [orders, setOrders] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState('');
      const [filter, setFilter] = useState('ALL'); // ALL | PENDING | COMPLETED | CANCELLED
      const [selectedOrderId, setSelectedOrderId] = useState(null);
      const [detail, setDetail] = useState(null);
      const [detailLoading, setDetailLoading] = useState(false);
      const [detailError, setDetailError] = useState('');

      useEffect(function () {
        async function loadOrders() {
          try {
            const base = (window.API_BASE || '').replace(/\/$/, '');
            const res = await fetch(base + '/api/orders?t=' + Date.now());
            if (!res.ok) {
              throw new Error('HTTP ' + res.status);
            }
            const data = await res.json();
            setOrders(data || []);
          } catch (err) {
            console.error('Failed to load my orders (demo)', err);
            setError("Erreur lors du chargement de vos commandes (d√©mo).");
          } finally {
            setLoading(false);
          }
        }

        loadOrders();

        const id = setInterval(loadOrders, 20000);
        return function () { clearInterval(id); };
      }, []);

      function mapStatusGroup(status) {
        if (!status) return 'OTHER';
        const s = String(status).toUpperCase();
        if (s.indexOf('CANCELLED') !== -1 || s.indexOf('ANNUL') !== -1) return 'CANCELLED';
        if (s.indexOf('PENDING') !== -1 || s.indexOf('EN_ATTENTE') !== -1) return 'PENDING';
        if (s.indexOf('PAID') !== -1 || s.indexOf('LIVR') !== -1) return 'COMPLETED';
        return 'PENDING';
      }

      function renderStatusBadge(status) {
        const group = mapStatusGroup(status);
        const label = status || 'En cours (d√©mo)';
        let bg = '#e3f2fd';
        let color = '#0d47a1';
        let icon = 'üõà';
        if (group === 'COMPLETED') { bg = '#e8f5e9'; color = '#1b5e20'; }
        if (group === 'CANCELLED') { bg = '#ffebee'; color = '#b71c1c'; icon = '‚úñ'; }
        if (group === 'PENDING') { icon = '‚è≥'; }
        const up = String(status || '').toUpperCase();
        if (up.indexOf('AWAITING_PAYMENT') !== -1) { icon = 'üíµ'; }
        if (up.indexOf('PAID_PREPARE_ORDER') !== -1) { icon = 'üöó'; bg = '#fff3cd'; color = '#856404'; }
        if (group === 'COMPLETED') { icon = '‚úì'; }
        return React.createElement(
          'span',
          {
            className: 'badge',
            style: {
              padding: '0.1rem 0.45rem',
              borderRadius: '999px',
              fontSize: '0.75rem',
              background: bg,
              color: color
            }
          },
          React.createElement('span', { className: 'badge-icon', 'aria-hidden': 'true' }, icon),
          React.createElement('span', { className: 'badge-text' }, label)
        );
      }

      function renderPaymentBadge(mode) {
        if (!mode) return null;
        let label = '';
        // default: ONLINE (PC), purple badge
        let icon = 'PC';
        let bg = '#f3e5f5';
        let color = '#4a148c';
        if (mode === 'ONLINE') { label = 'Paiement en ligne'; icon = 'PC'; }
        else if (mode === 'CREDIT') { label = 'Compte client / cr√©dit'; icon = 'üí≥'; }
        else if (mode === 'PAY_IN_SHOP') { label = 'Payer en magasin'; icon = 'üè¨'; bg = '#e30613'; color = '#fff'; }
        else { label = mode; }
        return React.createElement(
          'span',
          {
            className: 'badge',
            style: {
              padding: '0.1rem 0.45rem',
              borderRadius: '999px',
              fontSize: '0.75rem',
              background: bg,
              color: color,
              marginLeft: '0.25rem'
            }
          },
          React.createElement('span', { className: 'badge-icon', 'aria-hidden': 'true' }, icon),
          React.createElement('span', { className: 'badge-text' }, label)
        );
      }

      async function openDetail(orderId) {
        if (selectedOrderId === orderId) {
          setSelectedOrderId(null);
          setDetail(null);
          setDetailError('');
          return;
        }

        setSelectedOrderId(orderId);
        setDetail(null);
        setDetailError('');
        setDetailLoading(true);
        try {
          const base = (window.API_BASE || '').replace(/\/$/, '');
          const res = await fetch(base + '/api/orders/' + orderId + '?t=' + Date.now());
          if (!res.ok) {
            throw new Error('HTTP ' + res.status);
          }
          const data = await res.json();
          setDetail(data || null);
        } catch (err) {
          console.error('Failed to load order detail (demo)', err);
          setDetailError("Erreur lors du chargement du d√©tail de la commande (d√©mo).");
        } finally {
          setDetailLoading(false);
        }
      }

      const filteredOrders = orders.filter(function (o) {
        if (filter === 'ALL') return true;
        return mapStatusGroup(o.status) === filter;
      });

      if (loading) {
        return React.createElement('div', { className: 'cart-summary' }, 'Chargement de vos commandes (d√©mo)...');
      }

      if (error) {
        return React.createElement(
          'div',
          { className: 'cart-summary' },
          React.createElement('h2', null, 'Mes commandes (d√©mo)'),
          React.createElement('p', { style: { color: 'red' } }, error),
          React.createElement(
            'button',
            { type: 'button', onClick: onBackToShop },
            'Retour √† la boutique'
          )
        );
      }

      return React.createElement(
        'div',
        { className: 'cart-summary' },
        React.createElement('h2', null, 'Mes commandes (d√©mo)'),
        React.createElement(
          'div',
          { style: { display: 'flex', gap: '0.5rem', margin: '0.5rem 0' } },
          ['ALL', 'PENDING', 'COMPLETED', 'CANCELLED'].map(function (key) {
            const labels = {
              ALL: 'Toutes',
              PENDING: 'En cours',
              COMPLETED: 'Termin√©es',
              CANCELLED: 'Annul√©es'
            };
            return React.createElement(
              'button',
              {
                key: key,
                type: 'button',
                onClick: function () { setFilter(key); },
                style: {
                  background: filter === key ? '#0070f3' : '#eee',
                  color: filter === key ? '#fff' : '#333',
                  padding: '0.25rem 0.6rem',
                  borderRadius: '999px',
                  fontSize: '0.8rem'
                }
              },
              labels[key]
            );
          })
        ),
        filteredOrders.length === 0
          ? React.createElement('p', null, 'Aucune commande pour ce filtre.')
          : React.createElement(
              'div',
              { style: { display: 'flex', flexDirection: 'column', gap: '0.5rem', marginTop: '0.25rem' } },
              filteredOrders.map(function (order) {
                const isSelected = order.orderId === selectedOrderId;
                return React.createElement(
                  'div',
                  { key: order.orderId, style: { padding: '0.5rem', background: isSelected ? '#e0e0e0' : '#f9f9f9', borderRadius: '8px', boxShadow: '0 2px 4px rgba(0,0,0,0.1)' } },
                  React.createElement(
                    'div',
                    { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' } },
                    React.createElement('span', null, 'Commande #', order.orderId),
                    React.createElement('div', null)
                  ),
                  React.createElement(
                    'div',
                    { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginTop: '0.25rem', gap: '0.5rem' } },
                    React.createElement(
                      'span',
                      null,
                      'Statut : ',
                      renderStatusBadge(order.status),
                      ' ',
                      renderPaymentBadge(order.paymentMode)
                    ),
                    React.createElement(
                      'div',
                      { style: { display: 'flex', gap: '0.4rem', alignItems: 'center' } },
                      React.createElement(
                        'button',
                        {
                          type: 'button',
                          onClick: function (e) {
                            e.stopPropagation();
                            window.location.href = 'invoice.html?orderId=' + order.orderId;
                          },
                          style: { fontSize: '0.8rem', padding: '0.25rem 0.5rem', background: '#555' }
                        },
                        'Facture'
                      ),
                      React.createElement(
                        'button',
                        {
                          type: 'button',
                          onClick: function (e) { e.stopPropagation(); openDetail(order.orderId); },
                          style: { fontSize: '0.8rem', padding: '0.25rem 0.5rem', background: '#0070f3' }
                        },
                        isSelected ? 'Masquer le d√©tail' : 'Voir d√©tail'
                      )
                    )
                  ),
                  isSelected && React.createElement(
                    'div',
                    { style: { marginTop: '0.35rem', marginLeft: '0.25rem', paddingLeft: '0.35rem', borderLeft: '2px solid #ddd', fontSize: '0.85rem' } },
                    detailLoading && React.createElement('p', null, 'Chargement du d√©tail...'),
                    detailError && React.createElement('p', { style: { color: 'red' } }, detailError),
                    !detailLoading && !detailError && detail && React.createElement(
                      React.Fragment,
                      null,
                      React.createElement(
                        'div',
                        { style: { display: 'flex', gap: '1.5rem', alignItems: 'flex-start' } },
                        // Colonne 1 : informations de commande
                        React.createElement(
                          'div',
                          { style: { flex: '1 1 0' } },
                          React.createElement('p', null, 'Commande : ', detail.order.publicOrderCode || detail.order.orderId),
                          React.createElement('p', null, 'Client : ', detail.order.customerName || '', ' ‚Äì ', detail.order.email || ''),
                          detail.order.shopName && React.createElement('p', null, 'Magasin : ', detail.order.shopName),
                          detail.order.address && React.createElement('p', null, 'Adresse : ', detail.order.address)
                        ),
                        // Colonne 2 : articles + paiement (d√©mo)
                        React.createElement(
                          'div',
                          { style: { flex: '1 1 0' } },
                          React.createElement('p', null, 'Articles :'),
                          detail.items && detail.items.length > 0
                            ? React.createElement(
                                'ul',
                                null,
                                detail.items.map(function (it, idx) {
                                  const label = it.productName || ('Produit #' + it.productId);
                                  return React.createElement(
                                    'li',
                                    { key: idx },
                                    label,
                                    ' ‚Äì Qt√© ',
                                    it.quantity,
                                    ' √ó ‚Ç¨',
                                    Number(it.unitPrice || 0).toFixed(2)
                                  );
                                })
                              )
                            : React.createElement('p', null, '(Aucun article trouv√© pour cette commande.)'),
                          React.createElement('p', { style: { marginTop: '0.35rem' } }, 'Total : ‚Ç¨', Number(detail.order.totalAmount || 0).toFixed(2)),
                          String(detail.order.status || '').toUpperCase() === 'AWAITING_PAYMENT' && React.createElement(
                            'div',
                            { style: { marginTop: '0.5rem', padding: '0.4rem', background: '#fff3e0', borderRadius: '4px', fontSize: '0.8rem' } },
                            React.createElement('p', { style: { margin: 0, marginBottom: '0.35rem' } },
                              'Le magasin a confirm√© le stock. Vous pouvez proc√©der au paiement (d√©mo).'
                            ),
                            React.createElement('button', {
                              type: 'button',
                              style: { fontSize: '0.8rem', padding: '0.25rem 0.6rem', background: '#0070f3', color: '#fff', border: 'none', borderRadius: '4px', cursor: 'pointer' },
                              onClick: async function (e) {
                                e.stopPropagation();
                                try {
                                  const base = (window.API_BASE || '').replace(/\/$/, '');
                                  const payRes = await fetch(base + '/api/orders/' + detail.order.orderId + '/pay', {
                                    method: 'POST'
                                  });
                                  if (!payRes.ok) {
                                    throw new Error('HTTP ' + payRes.status);
                                  }

                                  try {
                                    const base2 = (window.API_BASE || '').replace(/\/$/, '');
                                    const listRes = await fetch(base2 + '/api/orders?t=' + Date.now());
                                    if (listRes.ok) {
                                      const listData = await listRes.json();
                                      setOrders(listData || []);
                                    }
                                  } catch (reloadErr) {
                                    console.error('Failed to reload orders after payment (client)', reloadErr);
                                  }

                                  setDetail(function (prev) {
                                    if (!prev || !prev.order) return prev;
                                    return Object.assign({}, prev, { order: Object.assign({}, prev.order, { status: 'PAID_PREPARE_ORDER' }) });
                                  });
                                } catch (payErr) {
                                  console.error('Failed to mark order as paid (client demo)', payErr);
                                  alert('Erreur lors du paiement (d√©mo).');
                                }
                              }
                            }, 'Payer maintenant (d√©mo)')
                          )
                        ),
                        // Colonne 3 : QR de confirmation de livraison (d√©mo)
                        String(detail.order.status || '').toUpperCase() === 'READY_FOR_DELIVERY' && React.createElement(
                          'div',
                          { style: { flex: '0 0 180px', textAlign: 'center' } },
                          React.createElement('p', { style: { fontSize: '0.8rem', marginTop: 0, marginBottom: '0.4rem', color: '#333' } },
                            'Scannez ce QR pour confirmer la livraison (d√©mo).'
                          ),
                          React.createElement('img', {
                            src: 'https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=' + encodeURIComponent((function(){ var dir = window.location.origin + window.location.pathname.replace(/[^/]*$/, ''); return dir + 'delivery.html?code=' + (detail.order.publicOrderCode || detail.order.orderId); })()),
                            alt: 'QR confirmation de livraison',
                            style: { width: '160px', height: '160px', borderRadius: '4px', background: '#fff' }
                          })
                        )
                      )
                    )
                  )
                );
              })
            ),
        React.createElement(
          'button',
          { type: 'button', onClick: onBackToShop, style: { marginTop: '0.75rem' } },
          'Retour √† la boutique'
        )
      );
    }

    function CartSummary({ cart, total, onRemove, onCheckout, onShowMyOrders, onChangeQty }) {
      return React.createElement(
        'div',
        { className: 'cart-summary' },
        // Top button: Mes commandes (placed above the cart header)
        onShowMyOrders && React.createElement(
          'div',
          { style: { marginBottom: '0.5rem' } },
          React.createElement(
            'button',
            {
              type: 'button',
              onClick: onShowMyOrders,
              style: { background: '#555', width: '100%' }
            },
            'Mes commandes (d√©mo)'
          )
        ),
        // Header with icon and total
        React.createElement(
          'div',
          { style: { display: 'flex', alignItems: 'center', gap: '0.4rem' } },
          React.createElement('span', { className: 'cart-icon', 'aria-hidden': 'true' }, 'üõí'),
          React.createElement('span', null, `Panier : ${cart.length} produits, total ‚Ç¨${total.toFixed(2)}`)
        ),
        // Items list
        cart.length > 0 &&
          React.createElement(
            'ul',
            null,
            cart.map(function (item) {
              return React.createElement(
                'li',
                { key: item.product.id },
                React.createElement(
                  'div',
                  { className: 'cart-summary-item-main' },
                  React.createElement(
                    'span',
                    {
                      className: 'cart-qty-badge',
                      'aria-label': 'Quantit√© ' + item.qty,
                      style: item.qty > 1 ? { background: '#0050b3' } : null
                    },
                    item.qty
                  ),
                  React.createElement(
                    'span',
                    { className: 'cart-summary-item-text' },
                    item.product.name + ' ‚Äì ‚Ç¨' + (Number(item.product.price) * item.qty).toFixed(2)
                  )
                ),
                React.createElement(
                  'div',
                  { style: { display: 'flex', alignItems: 'center', gap: '0.25rem' } },
                  onChangeQty && React.createElement(
                    'button',
                    {
                      type: 'button',
                      className: 'cart-qty-step',
                      onClick: function () { onChangeQty(item.product.id, -1); },
                      'aria-label': 'Diminuer la quantit√©'
                    },
                    '‚Äì'
                  ),
                  onChangeQty && React.createElement(
                    'button',
                    {
                      type: 'button',
                      className: 'cart-qty-step',
                      onClick: function () { onChangeQty(item.product.id, 1); },
                      'aria-label': 'Augmenter la quantit√©'
                    },
                    '+'
                  ),
                  React.createElement(
                    'button',
                    {
                      type: 'button',
                      className: 'cart-remove-icon-btn',
                      onClick: function () { onRemove(item.product.id); },
                      'aria-label': 'Retirer du panier'
                    },
                    '√ó'
                  )
                )
              );
            })
          ),
        // Bottom button: Passer √† la commande
        React.createElement(
          'div',
          { style: { marginTop: '0.5rem' } },
          React.createElement(
            'button',
            {
              onClick: onCheckout,
              disabled: cart.length === 0,
              style: { width: '100%' }
            },
            'Passer √† la commande (d√©mo)'
          )
        )
      );
    }

    function CheckoutView({ cart, total, onBack, onClearCart }) {
      const [name, setName] = useState('');
      const [email, setEmail] = useState('');
      const [phone, setPhone] = useState('');
      const [address, setAddress] = useState('');
      const [submitted, setSubmitted] = useState(false);
      const [paymentDone, setPaymentDone] = useState(false);
      const [orderId, setOrderId] = useState(null);
      const [publicOrderCode, setPublicOrderCode] = useState(null);
      const [paymentMode, setPaymentMode] = useState('ONLINE');
      const [deliveryMethod, setDeliveryMethod] = useState('STORE_PICKUP');
      const [deliveryDate, setDeliveryDate] = useState('');
      const [deliveryTime, setDeliveryTime] = useState('');
      const [submitting, setSubmitting] = useState(false);
      const [submitError, setSubmitError] = useState('');

      // Static list of shops for the demo; ids must match the backend shops table
      // These labels correspond to the real La Palette shops, sorted A ‚Üí Z
      const shops = [
        { id: 9, label: 'Antony' },
        { id: 8, label: 'Arcueil' },
        { id: 10, label: 'Bougival' },
        { id: 11, label: 'Boulogne' },
        { id: 12, label: 'Bourg la Reine' },
        { id: 13, label: 'Clichy' },
        { id: 14, label: 'Clichy sous bois' },
        { id: 3, label: 'Convention (Paris15e)' },
        { id: 15, label: 'Courbevoie' },
        { id: 4, label: 'Daumesnil (Paris12e)' },
        { id: 16, label: 'Joinville' },
        { id: 17, label: 'Le Perreux-sur-Marne' },
        { id: 18, label: 'Levallois' },
        { id: 19, label: 'Ormesson' },
        { id: 6, label: 'Pyr√©n√©es (Paris20e)' },
        { id: 20, label: 'Saint Ouen' },
        { id: 21, label: 'Saint-Maur' },
        { id: 7, label: 'St Antoine (Paris11e)' }
      ];

      const [selectedShopId, setSelectedShopId] = useState('');

      async function computeUsedCreditForEmail(email) {
        const CREDIT_LIMIT = 2000;
        if (!email) {
          return { limit: CREDIT_LIMIT, used: 0 };
        }
        try {
          const baseCredit = (window.API_BASE || '').replace(/\/$/, '');
          const res = await fetch(baseCredit + '/api/orders?t=' + Date.now());
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const orders = await res.json();
          const lowerEmail = String(email).toLowerCase();
          let used = 0;
          (orders || []).forEach(function (o) {
            if (!o) return;
            if (!o.email && o.customerEmail) {
              o.email = o.customerEmail;
            }
            const orderEmail = (o.email || '').toLowerCase();
            if (orderEmail !== lowerEmail) return;
            const mode = o.paymentMode || o.payment_mode;
            if (String(mode).toUpperCase() !== 'CREDIT') return;
            const status = String(o.status || '').toUpperCase();
            if (status.indexOf('CANCEL') !== -1 || status.indexOf('ANNUL') !== -1) return;
            const totalAmount = Number(o.totalAmount || o.total || 0);
            used += totalAmount;
          });
          return { limit: CREDIT_LIMIT, used: used };
        } catch (e) {
          console.error('Failed to compute used credit (checkout demo)', e);
          return { limit: CREDIT_LIMIT, used: 0 };
        }
      }

      async function handleSubmit(event) {
        event.preventDefault();
        if (!name || !email || !address) {
          alert('Merci de remplir au minimum Nom, Email et Adresse (d√©mo).');
          return;
        }

        if (!selectedShopId) {
          alert('Merci de choisir un magasin pour votre commande (d√©mo).');
          return;
        }

        if (deliveryMethod === 'DELIVERY') {
          if (!deliveryDate || !deliveryTime) {
            alert('Merci de choisir un jour et un cr√©neau horaire pour la livraison (d√©mo).');
            return;
          }
        }

        setSubmitting(true);
        setSubmitError('');

        try {
          // If payment is on credit, enforce demo credit limit
          if (paymentMode === 'CREDIT') {
            let authEmail = '';
            try {
              const rawUser = window.localStorage.getItem('lp_auth_user');
              if (rawUser) {
                const u = JSON.parse(rawUser) || {};
                if (u.email) authEmail = u.email;
              }
            } catch (e) {
              console.error('Failed to read auth user for credit (demo)', e);
            }
            const creditInfo = await computeUsedCreditForEmail(authEmail || email);
            const remaining = creditInfo.limit - creditInfo.used;
            if (total > remaining + 0.0001) {
              alert('Cr√©dit disponible insuffisant pour cette commande (d√©mo).');
              setSubmitting(false);
              return;
            }
          }

          const payload = {
            customer: { name, email, phone, address },
            items: cart.map(item => ({
              productId: item.product.id,
              name: item.product.name,
              qty: item.qty,
              price: item.product.price
            })),
            paymentMode,
            shopId: Number(selectedShopId),
            deliveryMethod,
            deliveryDate,
            deliveryTime
          };

          const baseCreate = (window.API_BASE || '').replace(/\/$/, '');
          const res = await fetch(baseCreate + '/api/orders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (!res.ok) {
            throw new Error('HTTP ' + res.status);
          }

          const data = await res.json();
          setOrderId(data.orderId || null);
          setPublicOrderCode(data.publicOrderCode || null);
          setSubmitted(true); // order is saved, go to payment step
          onClearCart();
        } catch (err) {
          console.error('Failed to submit order', err);
          setSubmitError("Erreur lors de l'enregistrement de la commande (d√©mo).");
        } finally {
          setSubmitting(false);
        }
      }

      if (submitted) {
        // New flow: after order is created, show a waiting screen instead of immediate payment
        return React.createElement(
          'div',
          { className: 'cart-summary' },
          React.createElement('h2', null, 'Commande enregistr√©e (d√©mo)'),
          (publicOrderCode || orderId) && React.createElement(
            'p',
            null,
            `Commande : ${publicOrderCode || orderId}`
          ),
          React.createElement('p', null,
            "Votre commande a √©t√© transmise au magasin s√©lectionn√©. Le stock sera v√©rifi√© par le magasin avant le paiement (d√©mo)."
          ),
          React.createElement('p', null,
            "Vous pourrez ensuite r√©gler votre commande une fois la confirmation re√ßue (par exemple via la page Mes commandes)."
          ),
          React.createElement(
            'button',
            { onClick: onBack },
            'Retour au catalogue'
          )
        );
      }

      return React.createElement(
        'div',
        null,
        React.createElement('h2', null, 'Commande (d√©mo)'),
        React.createElement(
          'div',
          { style: { display: 'grid', gridTemplateColumns: 'minmax(0, 2fr) minmax(0, 1fr)', gap: '1rem', marginTop: '0.5rem' } },
          React.createElement(
            'form',
            { onSubmit: handleSubmit, style: { background: '#fff', padding: '0.75rem', borderRadius: '6px', boxShadow: '0 2px 4px rgba(0,0,0,0.06)' } },
            React.createElement('div', null,
              React.createElement('label', null, 'Nom complet'),
              React.createElement('br'),
              React.createElement('input', {
                type: 'text',
                value: name,
                onChange: (e) => setName(e.target.value),
                style: { width: '100%', marginTop: '0.25rem', marginBottom: '0.5rem' }
              })
            ),
            React.createElement('div', null,
              React.createElement('label', null, 'Email'),
              React.createElement('br'),
              React.createElement('input', {
                type: 'email',
                value: email,
                onChange: (e) => setEmail(e.target.value),
                style: { width: '100%', marginTop: '0.25rem', marginBottom: '0.5rem' }
              })
            ),
            React.createElement('div', null,
              React.createElement('label', null, 'T√©l√©phone'),
              React.createElement('br'),
              React.createElement('input', {
                type: 'tel',
                value: phone,
                onChange: (e) => setPhone(e.target.value),
                style: { width: '100%', marginTop: '0.25rem', marginBottom: '0.5rem' }
              })
            ),
            React.createElement('div', null,
              React.createElement('label', null, 'Adresse'),
              React.createElement('br'),
              React.createElement('textarea', {
                value: address,
                onChange: (e) => setAddress(e.target.value),
                rows: 3,
                style: { width: '100%', marginTop: '0.25rem', marginBottom: '0.5rem' }
              })
            ),
            React.createElement('div', null,
              React.createElement('label', null, 'Magasin (d√©mo)'),
              React.createElement('br'),
              React.createElement('select', {
                value: selectedShopId,
                onChange: (e) => setSelectedShopId(e.target.value),
                style: { width: '100%', marginTop: '0.25rem', marginBottom: '0.5rem' }
              },
                React.createElement('option', { value: '' }, 'Choisir un magasin...'),
                shops.map(function (s) {
                  return React.createElement('option', { key: s.id, value: String(s.id) }, s.label);
                })
              )
            ),
            React.createElement('div', null,
              React.createElement('label', null, 'Mode de paiement (d√©mo)'),
              React.createElement('br'),
              React.createElement('select', {
                value: paymentMode,
                onChange: (e) => setPaymentMode(e.target.value),
                style: { width: '100%', marginTop: '0.25rem', marginBottom: '0.5rem' }
              },
                React.createElement('option', { value: 'ONLINE' }, 'Paiement en ligne (d√©mo)'),
                React.createElement('option', { value: 'CREDIT' }, 'Compte client / cr√©dit (d√©mo)'),
                React.createElement('option', { value: 'PAY_IN_SHOP' }, 'Payer en magasin (d√©mo)')
              )
            ),
            React.createElement('div', null,
              React.createElement('label', null, 'Mode de livraison (d√©mo)'),
              React.createElement('br'),
              React.createElement('select', {
                value: deliveryMethod,
                onChange: function (e) { setDeliveryMethod(e.target.value); },
                style: { width: '100%', marginTop: '0.25rem', marginBottom: '0.5rem' }
              },
                React.createElement('option', { value: 'STORE_PICKUP' }, 'Retrait en magasin'),
                React.createElement('option', { value: 'DELIVERY' }, 'Livraison √† domicile')
              )
            ),
            deliveryMethod === 'DELIVERY' && React.createElement('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '0.5rem', marginBottom: '0.5rem' } },
              React.createElement('div', null,
                React.createElement('label', null, 'Jour de livraison souhait√© (d√©mo)'),
                React.createElement('br'),
                React.createElement('input', {
                  type: 'date',
                  value: deliveryDate,
                  onChange: function (e) { setDeliveryDate(e.target.value); },
                  style: { width: '100%', marginTop: '0.25rem' }
                })
              ),
              React.createElement('div', null,
                React.createElement('label', null, 'Cr√©neau horaire (d√©mo)'),
                React.createElement('br'),
                React.createElement('select', {
                  value: deliveryTime,
                  onChange: function (e) { setDeliveryTime(e.target.value); },
                  style: { width: '100%', marginTop: '0.25rem' }
                },
                  React.createElement('option', { value: '' }, 'Choisir un cr√©neau...'),
                  React.createElement('option', { value: 'MORNING' }, 'Matin (9h - 12h)'),
                  React.createElement('option', { value: 'AFTERNOON' }, 'Apr√®s-midi (13h - 17h)'),
                  React.createElement('option', { value: 'EVENING' }, 'Fin de journ√©e (17h - 19h)')
                )
              )
            ),
            React.createElement(
              'button',
              { type: 'submit', disabled: submitting },
              submitting ? 'Envoi en cours...' : 'Confirmer la commande (d√©mo)'
            ),
            React.createElement(
              'button',
              {
                type: 'button',
                onClick: onBack,
                style: { marginLeft: '0.5rem', background: '#666' }
              },
              'Annuler et revenir'
            )
          ),
          React.createElement(
            'div',
            { className: 'cart-summary' },
            submitError && React.createElement('div', { style: { color: 'red', marginBottom: '0.5rem' } }, submitError),
            React.createElement('div', null, `R√©capitulatif panier (${cart.length} produits)`),
            cart.length > 0 && React.createElement(
              'ul',
              null,
              cart.map(item =>
                React.createElement(
                  'li',
                  { key: item.product.id },
                  `${item.product.name} √ó ${item.qty} ‚Äì ‚Ç¨${(Number(item.product.price) * item.qty).toFixed(2)}`
                )
              )
            ),
            React.createElement('div', { style: { marginTop: '0.5rem', fontWeight: 600 } }, `Total : ‚Ç¨${total.toFixed(2)}`)
          )
        )
      );
    }

    function CategoryBar({ categories, selectedCategory, onSelectCategory }) {
      if (!categories || categories.length <= 1) {
        return null;
      }

      return React.createElement(
        'div',
        { className: 'category-bar' },
        categories.map(cat =>
          React.createElement(
            'button',
            {
              key: cat,
              type: 'button',
              className: 'category-chip' + (cat === selectedCategory ? ' active' : ''),
              onClick: () => onSelectCategory(cat)
            },
            cat
          )
        )
      );
    }

    function ProductList({ products, onAddToCart, onSelect }) {
      if (!products || products.length === 0) {
        return React.createElement('div', null, 'No products yet. Add some rows to the products table in Neon.');
      }

      return React.createElement(
        'div',
        { className: 'products' },
        products.map(p =>
          React.createElement(
            'div',
            {
              key: p.id,
              className: 'product-card',
              onClick: () => onSelect && onSelect(p)
            },
            p.imageUrl
              ? React.createElement('img', {
                  src: normalizeImageUrl(p.imageUrl),
                  alt: p.name,
                  className: 'product-image',
                  onError: function (e) {
                    // Final fallback: inline placeholder
                    e.target.onerror = null;
                    e.target.src = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="400" height="180"><rect width="100%" height="100%" fill="#eeeeee"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="14" fill="#999">Image indisponible</text></svg>');
                  }
                })
              : React.createElement('div', { className: 'product-image', style: { background: '#eee', minHeight: '180px' } }),
            React.createElement('h3', null, p.name),
            p.description && React.createElement('p', null, p.description),
            React.createElement('div', { className: 'price' }, `‚Ç¨${Number(p.price).toFixed(2)}`),
            React.createElement(
              'div',
              { style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: '0.5rem', marginTop: '0.25rem' } },
              React.createElement(
                'input',
                {
                  type: 'number',
                  min: '0',
                  step: '1',
                  defaultValue: '0',
                  style: { width: '60px', fontSize: '0.85rem' },
                  onClick: (event) => event.stopPropagation(),
                  onKeyDown: (event) => event.stopPropagation(),
                  ref: function (el) { p.__qtyInput = el; }
                }
              ),
              React.createElement(
                'button',
                {
                  onClick: (event) => {
                    event.stopPropagation();
                    var qty = 0;
                    if (p.__qtyInput && typeof p.__qtyInput.value !== 'undefined') {
                      qty = Number(p.__qtyInput.value || '0');
                    }
                    onAddToCart(p, qty);
                  }
                },
                'Add to cart'
              )
            )
          )
        )
      );
    }

    function ProductDetail({ product, onClose, onAddToCart }) {
      // Simple two-column layout inspired by la-palette detail page
      return React.createElement(
        'div',
        { className: 'detail-overlay', onClick: onClose },
        React.createElement(
          'div',
          {
            className: 'detail-panel',
            onClick: (e) => e.stopPropagation()
          },
          React.createElement(
            'div',
            { className: 'detail-header' },
            React.createElement('h2', { style: { color: '#e0001a', fontSize: '1.4rem' } }, product.name),
            React.createElement(
              'button',
              { onClick: onClose, style: { background: '#444' } },
              'Fermer'
            )
          ),
          React.createElement(
            'div',
            {
              style: {
                display: 'grid',
                gridTemplateColumns: 'minmax(0, 220px) minmax(0, 1fr)',
                gap: '1rem',
                alignItems: 'flex-start'
              }
            },
            // Left column: large image
            product.imageUrl
              ? React.createElement('img', {
                  src: normalizeImageUrl(product.imageUrl),
                  alt: product.name,
                  className: 'detail-image',
                  onError: function (e) { e.target.style.display = 'none'; }
                })
              : React.createElement('div', { style: { minHeight: '180px', background: '#eee', borderRadius: '6px' } }),
            // Middle column: text content
            React.createElement(
              'div',
              null,
              React.createElement(
                'div',
                { style: { fontSize: '0.85rem', color: '#c00018', marginBottom: '0.5rem' } },
                "Peintures ¬∑ Peinture Int√©rieure ¬∑ Mat ¬∑ A l'eau (d√©mo)"
              ),
              product.description &&
                React.createElement(
                  'p',
                  { style: { marginTop: 0, marginBottom: '0.5rem', lineHeight: 1.4 } },
                  product.description
                ),
              React.createElement(
                'div',
                { style: { marginBottom: '0.5rem', fontWeight: 600 } },
                `Prix d√©mo : ‚Ç¨${Number(product.price).toFixed(2)}`
              ),
              React.createElement(
                'button',
                { onClick: () => onAddToCart(product) },
                'Ajouter au panier (d√©mo)'
              )
            )
          )
        )
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(App));
  </script>
</body>
</html>
